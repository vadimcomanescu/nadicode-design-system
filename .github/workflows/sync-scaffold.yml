name: Sync scaffold

on:
  push:
    branches: [master]
    paths-ignore:
      - ".github/**"
      - "plans/**"
      - "README.md"

  workflow_dispatch:

jobs:
  precheck:
    runs-on: ubuntu-latest
    outputs:
      enabled: ${{ steps.check.outputs.enabled }}
    steps:
      - name: Check scaffold sync configuration
        id: check
        run: |
          if [ -z "${{ secrets.SCAFFOLD_PAT }}" ]; then
            echo "enabled=false" >> "$GITHUB_OUTPUT"
            echo "SCAFFOLD_PAT is not configured, scaffold sync will be skipped."
          else
            echo "enabled=true" >> "$GITHUB_OUTPUT"
            echo "SCAFFOLD_PAT is configured, scaffold sync will run."
          fi

  sync:
    runs-on: ubuntu-latest
    needs: precheck
    if: needs.precheck.outputs.enabled == 'true'
    steps:
      - name: Checkout design system
        uses: actions/checkout@v4
        with:
          path: ds

      - name: Checkout scaffold
        uses: actions/checkout@v4
        with:
          repository: vadimcomanescu/scaffold-nextjs-saas
          token: ${{ secrets.SCAFFOLD_PAT }}
          path: scaffold

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install scaffold deps
        working-directory: scaffold
        run: npm ci

      - name: Run init --update
        working-directory: scaffold
        run: node ../ds/bin/init.mjs --update --skip-deps

      - name: Check for changes
        id: diff
        working-directory: scaffold
        run: |
          git diff --quiet && echo "changed=false" >> "$GITHUB_OUTPUT" || echo "changed=true" >> "$GITHUB_OUTPUT"

      - name: Typecheck scaffold
        if: steps.diff.outputs.changed == 'true'
        working-directory: scaffold
        run: npx tsc --noEmit

      - name: Lint scaffold
        if: steps.diff.outputs.changed == 'true'
        working-directory: scaffold
        run: npx eslint .

      - name: Test scaffold
        if: steps.diff.outputs.changed == 'true'
        working-directory: scaffold
        run: npx vitest run

      - name: Build scaffold
        if: steps.diff.outputs.changed == 'true'
        working-directory: scaffold
        run: npm run build

      - name: Get DS commit info
        if: steps.diff.outputs.changed == 'true'
        id: ds-info
        working-directory: ds
        run: |
          echo "sha=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"
          echo "msg=$(git log -1 --format=%s)" >> "$GITHUB_OUTPUT"

      - name: Create or update PR
        if: steps.diff.outputs.changed == 'true'
        working-directory: scaffold
        env:
          GH_TOKEN: ${{ secrets.SCAFFOLD_PAT }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          BRANCH="chore/sync-ds"
          git fetch origin "$BRANCH" 2>/dev/null || true
          git checkout -B "$BRANCH"
          git add -A
          git commit -m "$(cat <<'EOF'
          Sync design system (${{ steps.ds-info.outputs.sha }})

          Upstream: ${{ steps.ds-info.outputs.msg }}
          EOF
          )"
          git push --force-with-lease -u origin "$BRANCH"

          EXISTING_PR=$(gh pr list --head "$BRANCH" --json number --jq '.[0].number')
          if [ -n "$EXISTING_PR" ]; then
            gh pr edit "$EXISTING_PR" \
              --title "Sync design system (latest: ${{ steps.ds-info.outputs.sha }})" \
              --body "$(cat <<'EOF'
          ## Summary

          Auto-sync from [nadicode-design-system@`${{ steps.ds-info.outputs.sha }}`](https://github.com/vadimcomanescu/nadicode-design-system/commit/${{ steps.ds-info.outputs.sha }}).

          Upstream commit: **${{ steps.ds-info.outputs.msg }}**

          ## Validated

          - [x] `tsc --noEmit` passed
          - [x] `eslint .` passed
          - [x] `vitest run` passed
          - [x] `next build` passed

          ## Review checklist

          - [ ] Check diff for token/component changes
          - [ ] Verify dev server renders correctly
          EOF
          )"
            echo "Updated existing PR #$EXISTING_PR"
          else
            gh pr create \
              --title "Sync design system (latest: ${{ steps.ds-info.outputs.sha }})" \
              --body "$(cat <<'EOF'
          ## Summary

          Auto-sync from [nadicode-design-system@`${{ steps.ds-info.outputs.sha }}`](https://github.com/vadimcomanescu/nadicode-design-system/commit/${{ steps.ds-info.outputs.sha }}).

          Upstream commit: **${{ steps.ds-info.outputs.msg }}**

          ## Validated

          - [x] `tsc --noEmit` passed
          - [x] `eslint .` passed
          - [x] `vitest run` passed
          - [x] `next build` passed

          ## Review checklist

          - [ ] Check diff for token/component changes
          - [ ] Verify dev server renders correctly
          EOF
          )"
            echo "Created new PR"
          fi

  sync-skipped:
    runs-on: ubuntu-latest
    needs: precheck
    if: needs.precheck.outputs.enabled != 'true'
    steps:
      - name: Scaffold sync skipped
        run: echo "Skipping scaffold sync because SCAFFOLD_PAT is not configured."
